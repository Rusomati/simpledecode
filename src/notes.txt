switch from read to mmap
and clean up the code
